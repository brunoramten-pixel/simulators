<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SIMULADOR CLÍNICO AVANZADO - Sarampión - RESET TIEMPO</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui, "Segoe UI", Roboto, sans-serif;background:#f5f6fa;color:#2c3e50;font-size:13px}
.medical-header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:8px 0;position:fixed;top:0;left:0;right:0;z-index:100}
.header-content{max-width:1400px;margin:0 auto;padding:0 15px;display:flex;justify-content:space-between;align-items:center}
.system-title{font-size:1.3em;font-weight:700}
.timer-bar{position:fixed;top:50px;left:0;right:0;background:#fff;padding:8px 15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);z-index:99;display:flex;justify-content:space-between;align-items:center}
.main-timer{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;padding:8px 15px;border-radius:4px;font-size:1.6em;font-weight:700;font-family:"Courier New",monospace;min-width:120px;text-align:center}
.main-timer.critical{animation:criticalFlash 1s infinite}
@keyframes criticalFlash{0%,50%{opacity:1}51%,100%{opacity:.6}}
.critical-alert{background:#dc3545;color:#fff;padding:6px 12px;border-radius:15px;font-weight:600;font-size:.9em;animation:alertPulse 2s infinite}
@keyframes alertPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.main-container{margin-top:95px;max-width:1400px;margin-left:auto;margin-right:auto;padding:10px;display:grid;grid-template-columns:1.3fr 1fr;gap:15px;min-height:calc(100vh - 105px)}
.panel{background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.08);display:flex;flex-direction:column;overflow:hidden}
.panel-header{color:#fff;padding:10px 15px;font-size:1em;font-weight:600}
.patient-header{background:linear-gradient(135deg,#3498db,#2980b9)}
.treatment-header{background:linear-gradient(135deg,#27ae60,#229954)}
.panel-content{padding:12px;flex:1;overflow:auto}
.info-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
.info-card{background:#f8f9fa;padding:6px;border-radius:4px;text-align:center;border-left:2px solid #3498db}
.info-label{font-size:.7em;color:#666;text-transform:uppercase;letter-spacing:.3px}
.info-value{font-size:.85em;font-weight:600;color:#2c3e50;margin-top:1px}
.patient-visual-container{display:grid;grid-template-columns:140px 1fr;gap:15px;margin:10px 0;height:180px}
.patient-visual{display:flex;justify-content:center;align-items:center;background:#f8f9fa;border-radius:6px;padding:10px;position:relative}
.ecg-monitor{background:#000;border-radius:6px;padding:10px;position:relative;border:2px solid #222}
.ecg-header{color:#00ff00;font-family:"Courier New",monospace;font-size:.8em;text-align:center;margin-bottom:6px}
.ecg-layer{position:relative;height:120px}
canvas#ecgCanvas{width:100%;height:120px;background:#000;border-radius:2px;display:block}
.ecg-info{color:#00ff00;font-family:"Courier New",monospace;font-size:.7em;text-align:center;margin-top:6px}
.ecg-led{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;box-shadow:0 0 6px #00ff00;background:#00ff00}
.sound-controls{display:flex;gap:8px;align-items:center;margin-top:8px;color:#fff}
.sound-btn{background:linear-gradient(135deg,#444,#222);padding:6px 8px;border-radius:6px;border:1px solid #666;cursor:pointer;color:#fff}
.sound-label{font-size:.8em;color:#ddd;margin-right:6px}
input[type="range"]{appearance:none;height:6px;border-radius:6px;background:#333;outline:none}
input[type="range"]::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:#00ff66;cursor:pointer;border:2px solid #fff}
.body-silhouette{width:100px;height:160px;position:relative;display:block}
.body-part{position:absolute;border:2px solid #34495e;border-radius:4px;transform-origin:center center;background-image:radial-gradient(circle, rgba(255,0,0,0.9) 0 2px, transparent 3px);background-repeat:repeat;background-size:20px 20px;}
.head{width:25px;height:30px;background:#2ecc71;border-radius:50%;top:0;left:50%;transform:translate(-50%,0)}
.torso{width:35px;height:50px;background:#2ecc71;top:30px;left:50%;transform:translate(-50%,0);border-radius:8px}
.arm-left,.arm-right{width:12px;height:40px;background:#27ae60;top:35px;border-radius:6px}
.arm-left{left:10px} .arm-right{right:10px}
.leg-left,.leg-right{width:14px;height:60px;background:#2ecc71;border-radius:6px;bottom:0}
.leg-left{left:28px} .leg-right{right:28px}
.compact-vitals{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:10px 0}
.vital-compact{background:#000;color:#00ff00;padding:8px;border-radius:4px;font-family:"Courier New",monospace;position:relative;border:1px solid #333;text-align:center}
.vital-compact.critical{color:#ff0000;border-color:#dc3545;animation:criticalAlarm 1.5s infinite}
@keyframes criticalAlarm{0%,50%{background:#000}51%,100%{background:#220000}}
.vital-value-compact{font-size:1.1em;font-weight:700} .vital-label-compact{font-size:.65em;opacity:.8;margin-top:2px}
.pain-meter-compact{background:linear-gradient(135deg,#dc3545,#8b0000);color:#fff;padding:8px;border-radius:4px;text-align:center;margin:8px 0}
.pain-scale-compact{font-size:1.8em;font-weight:700}
/* --- cambios: sintomas siempre visibles --- */
.symptoms-timeline{background:#f8f9fa;border-radius:4px;padding:8px;margin:8px 0;border-left:3px solid #3498db; /* quitar max-height/scroll */}
.symptom-group{margin-bottom:6px;padding:6px;background:#fff;border-radius:3px;border-left:2px solid #dee2e6;opacity:0.95}
.symptom-group.active{border-left-color:#e74c3e;background:#fff5f5}
.form-group{margin-bottom:10px} .form-label{display:block;margin-bottom:4px;font-weight:600;color:#34495e;font-size:.85em} .form-control{width:100%;padding:6px 8px;border:1px solid #dee2e6;border-radius:3px;font-size:.8em}
.btn{background:linear-gradient(135deg,#27ae60,#229954);color:#fff;border:0;padding:8px 12px;border-radius:3px;font-size:.8em;font-weight:600;cursor:pointer}
.btn.urgent{background:linear-gradient(135deg,#dc3545,#8b0000);animation:urgentPulse 2s infinite}
@keyframes urgentPulse{0%,100%{box-shadow:0 1px 2px rgba(220,53,69,.3)}50%{box-shadow:0 2px 6px rgba(220,53,69,.6)}}
.pharmacology-alert{padding:8px;border-radius:3px;margin:6px 0;font-size:.75em;font-weight:600}
.alert-success{background:#ccf2e8;border:1px solid #99e6d1;color:#155724}
.alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
.alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(44,62,80,.95);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:6px;max-width:800px;width:90%;max-height:80vh;overflow:auto;text-align:center}
.success-result{background:linear-gradient(135deg,#27ae60,#229954);color:#fff;padding:15px;border-radius:6px;margin:10px 0}
.failure-result{background:linear-gradient(135deg,#e74c3e,#c0392b);color:#fff;padding:15px;border-radius:6px;margin:10px 0}
.result-icon{font-size:3em;margin:10px 0}
.paused-overlay{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.9);font-weight:700;font-size:1.2em;pointer-events:none}
.patient-history{background:#fff;padding:8px;border-radius:6px;border:1px solid #e6eef7;margin:10px 0}
.patient-history h4{margin-bottom:6px;font-size:.9em}
@media (max-width:900px){ .main-container{grid-template-columns:1fr} .header-content{flex-direction:column;gap:6px} }
</style>
</head>
<body>
<div class="medical-header">
  <div class="header-content">
    <div>
      <div class="system-title">SIMULADOR FARMACOLÓGICO AVANZADO</div>
      <div style="font-size:.8em;opacity:.9">Escuela de Medicina | Infecciosas y Control de Brotes</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:.8em"></div>
      <div style="font-size:.7em;opacity:.8">Protocolo: Manejo de Sarampión</div>
    </div>
  </div>
</div>

<div class="timer-bar">
  <div class="main-timer" id="mainTimer">05:00</div>
  <div style="display:flex;gap:12px;align-items:center">
    <div style="color:#666;font-size:.9em">Estado: <span id="patientStatus">Evaluación inicial</span></div>
  </div>
</div>

<div class="main-container">
  <div class="panel patient-panel">
    <div class="panel-header patient-header">MONITOREO DEL PACIENTE</div>
    <div class="panel-content">
      <div class="info-grid">
        <div class="info-card"><div class="info-label">Paciente</div><div class="info-value">Ana Martínez</div></div>
        <div class="info-card"><div class="info-label">Edad</div><div class="info-value">22 años</div></div>
        <div class="info-card"><div class="info-label">Peso</div><div class="info-value">60 kg</div></div>
        <div class="info-card"><div class="info-label">Talla</div><div class="info-value">1.60 m</div></div>
      </div>

      <div class="patient-visual-container">
        <div class="patient-visual" id="visualWrap">
          <div class="body-silhouette" id="patientBody">
            <div class="body-part head" id="partHead"></div>
            <div class="body-part torso" id="partTorso"></div>
            <div class="body-part arm-left" id="partArmL"></div>
            <div class="body-part arm-right" id="partArmR"></div>
            <div class="body-part leg-left" id="partLegL"></div>
            <div class="body-part leg-right" id="partLegR"></div>
          </div>
        </div>

        <div class="ecg-monitor" id="ecgMonitor">
          <div class="ecg-led" id="ecgLed"></div>
          <div class="ecg-header">ELECTROCARDIOGRAMA</div>
          <div class="ecg-layer">
            <canvas id="ecgCanvas" width="800" height="120"></canvas>
            <div class="paused-overlay" id="ecgPaused" style="display:none">PAUSADO</div>
          </div>
          <div class="ecg-info">FC: <span id="ecgRate">85</span> lpm | Ritmo: <span id="ecgRhythm">Sinusal</span></div>

          <div class="sound-controls" style="position:relative;margin-top:10px">
            <div class="sound-label">Sonido monitor:</div>
            <button id="soundToggle" class="sound-btn">Activar</button>
            <div style="display:flex;align-items:center;margin-left:8px">
              <input id="soundVolume" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px" title="Volumen"/>
            </div>
          </div>
        </div>
      </div>

      <div class="pain-meter-compact">
        <div style="font-size:.8em">ESCALA ANÁLOGA VISUAL</div>
        <div class="pain-scale-compact" id="painScore">7</div>
        <div style="font-size:.7em">Malestar general</div>
      </div>

      <div class="compact-vitals">
        <div class="vital-compact" id="hrMonitor"><div class="vital-value-compact" id="heartRate">85</div><div class="vital-label-compact">FC (lpm)</div></div>
        <div class="vital-compact" id="bpMonitor"><div class="vital-value-compact" id="bloodPressure">140/90</div><div class="vital-label-compact">PA (mmHg)</div></div>
        <div class="vital-compact" id="tempMonitor"><div class="vital-value-compact" id="temperature">36.8</div><div class="vital-label-compact">TEMP (°C)</div></div>
        <div class="vital-compact" id="spo2Monitor"><div class="vital-value-compact" id="oxygenSat">97</div><div class="vital-label-compact">SpO₂ (%)</div></div>
      </div>

      <!-- Antecedentes añadidos -->
      <div class="patient-history" id="patientHistory">
        <h4>Antecedentes personales</h4>
        <ul style="margin-left:14px">
          <li>Fiebre de inicio súbito hace 3 días</li>
          <li>Tos seca, coriza y conjuntivitis desde 48 h</li>
          <li>Aparecen manchas en mucosa oral (manchas de Koplik) reportadas</li>
          <li>No refiere comorbilidades crónicas conocidas</li>
        </ul>
      </div>

      <div class="symptoms-timeline">
        <h4 style="margin-bottom:8px;color:#2c3e50;font-size:.9em">EVOLUCIÓN CLÍNICA</h4>
        <div id="symptomsContainer">
          <div class="symptom-group active">
            <div class="time-stamp">T+00:00 - Ingreso</div>
            <div class="symptom-list">• Fiebre alta y malestar general<br>• Tos seca, coriza y conjuntivitis<br>• Síntomas prodrómicos (manchas de Koplik)</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel treatment-panel">
    <div class="panel-header treatment-header">PROTOCOLO FARMACOLÓGICO</div>
    <div class="panel-content">
      

      <div class="form-group">
        <label class="form-label">Selección farmacológica:<\/label>
        <select class="form-control" id="drugSelection">
          <option value="">-- Seleccionar fármaco/intervención --</option>
          <option value="paracetamol">Paracetamol (acetaminofén)</option>
          <option value="cristaloides_iv">Líquidos IV (Ringer lactato / Salina)</option>
          <option value="oxygen">Oxígeno suplementario (mascarilla/cánula)</option>
          <option value="antibiotic_if_bacterial">Antibiótico (si sospecha sobreinfección bacteriana)</option>
          <option value="immunoglobulin">Inmunoglobulina humana (casos selectos / profilaxis post-exposición)</option>
          <option value="vitaminaA">Vitamina A (terapia adyuvante)</option>
          <option value="no_aspirina">Evitar AINES/Ácido acetilsalicílico</option>
        </select>
      </div>

      <div class="form-group" style="display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <label class="form-label">Dosis (número):</label>
          <input class="form-control" id="drugDose" type="number" min="0.1" max="1000000" step="0.1" placeholder="Dosis" />
        </div>
        <div style="width:70px;margin-top:22px;text-align:left"><span id="doseUnit">mg</span></div>
      </div>

      <button class="btn urgent" id="administerDrug">ADMINISTRAR MEDICAMENTO</button>
      <div id="drugEffects" style="display:none;margin-top:8px"></div>

      <hr style="margin:12px 0;border:1px solid #dee2e6">

      <div class="form-group">
        <label class="form-label">Diagnóstico Diferencial:</label>
        <select class="form-control" id="diagnosis">
          <option value="">-- Seleccionar diagnóstico --</option>
          <option value="sarampion_classic">Sarampión clásico (no complicado)</option>
          <option value="sarampion_complicado">Sarampión con complicaciones (neumonía/encefalitis)</option>
          <option value="rubeola">Rubéola</option>
          <option value="varicela">Varicela</option>
          <option value="escarlatina">Escarlatina</option>
        </select>
      </div>

      <div class="form-group">
        <fieldset style="border:1px solid #e6eef7;padding:12px;border-radius:6px;background:#fbfcfe">
          <legend style="font-weight:700;padding:0 6px">Estudios de laboratorio</legend>
          <div style="display:flex;flex-direction:column;gap:8px;padding-top:6px">
            <label><input type="checkbox" name="labs" value="bh" class="labCheckbox"> <strong>Hemograma (Hb/Leucocitos/Neutrófilos)</strong></label>
            <label><input type="checkbox" name="labs" value="ser" class="labCheckbox"> <strong>Serología: IgM/IgG para sarampión</strong></label>
            <label><input type="checkbox" name="labs" value="rx" class="labCheckbox"> <strong>Radiografía de tórax (si sospecha de neumonía)</strong></label>
            <label><input type="checkbox" name="labs" value="o2" class="labCheckbox"> <strong>Gasometría / SpO₂</strong></label>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="confirmLabs" class="btn">Confirmar estudios de laboratorio</button>
            <div id="labStatus" style="font-size:.85em;color:#666">Seleccione los estudios y presione confirmar.</div>
          </div>
          <div id="labResults" style="margin-top:10px;display:none;background:#fff;padding:10px;border-radius:6px;border:1px solid #e9f3ff"></div>
        </fieldset>
      </div>

      <div class="form-group">
        <label class="form-label">Tratamiento Definitivo:</label>
        <select class="form-control" id="definiteTreatment">
          <option value="">-- Seleccionar intervención --</option>
          <option value="supportive_hospitalize">Hospitalización y soporte (rehidratación + Vitamina A)</option>
          <option value="outpatient_follow">Alta con aislamiento y seguimiento ambulatorio</option>
          <option value="antibiotic_if_bacterial">Antibiótico si complicación bacteriana</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Seguimiento:</label>
        <select class="form-control" id="followUp">
          <option value="">-- Seleccionar seguimiento --</option>
          <option value="isolate_notify">Aislamiento e notificación a salud pública</option>
          <option value="monitor_resp">Monitorización respiratoria en hospital</option>
          <option value="ambulatory_return">Control ambulatorio en 48-72 h</option>
        </select>
      </div>

      <button class="btn" id="submitTreatment">CONFIRMAR PLAN TERAPÉUTICO</button>
      <div id="treatmentResponse" style="display:none;margin-top:8px"></div>

    </div>
  </div>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <h2 id="modalTitle">Resultado</h2>
    <div id="modalContent"></div>
    <button class="btn" id="newSimBtn">Nueva Simulación</button>
  </div>
</div>

<script>
/* ECG integrado con sonido: sube 25 lpm cada minuto, parte en 85 lpm.
   Sonido del monitor: click/beep en cada QRS. Hay control para activar y ajustar volumen.
*/
(function(){
  const canvas = document.getElementById('ecgCanvas');
  const ctx = canvas.getContext('2d');
  const parent = canvas.parentElement;
  let dpr = window.devicePixelRatio || 1;

  // audio
  let audioCtx = null;
  let masterGain = null;
  let soundEnabled = false;
  const defaultVolume = 0.6;

  function ensureAudio(){ // create/resume audio context on user gesture
    if (!audioCtx){
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = defaultVolume;
        masterGain.connect(audioCtx.destination);
      } catch(e){
        console.warn('AudioContext no soportado', e);
      }
    } else if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  function setVolume(v){
    if (masterGain) masterGain.gain.value = v;
  }

  function playBeep(){
    if (!soundEnabled) return;
    ensureAudio();
    if (!audioCtx) return;
    const now = audioCtx.currentTime;
    // short click-like beep: two oscillators for richer sound
    const o1 = audioCtx.createOscillator();
    const g1 = audioCtx.createGain();
    o1.type = 'sine';
    o1.frequency.value = 900;
    g1.gain.setValueAtTime(0, now);
    g1.gain.linearRampToValueAtTime(0.9, now + 0.002);
    g1.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
    o1.connect(g1);
    g1.connect(masterGain);

    const o2 = audioCtx.createOscillator();
    const g2 = audioCtx.createGain();
    o2.type = 'triangle';
    o2.frequency.value = 1300;
    g2.gain.setValueAtTime(0, now);
    g2.gain.linearRampToValueAtTime(0.5, now + 0.002);
    g2.gain.exponentialRampToValueAtTime(0.001, now + 0.09);
    o2.connect(g2);
    g2.connect(masterGain);

    o1.start(now);
    o2.start(now);
    o1.stop(now + 0.1);
    o2.stop(now + 0.12);
  }

  // ECG drawing state
  let isRunning = false;
  let raf = null;
  let ecgStartTime = 0; // timestamp when ECG started
  let lastFrame = 0;
  let writeX = 0;
  let ecgData = [];
  let totalBeats = 0;

  const ecgPattern = [0,0,0,0.02,0.04,0.08,0.12,0.08,0.03,0,-0.05,-0.12,-0.06,0,0.15,0.8,1.0,0.78,0.28,-0.15,-0.45,-0.18,0.05,0.22,0.14,0.06,0.02,0,0,0,0,0,0];
  const sampleSpacing = 3;

  function resizeCanvas(){
    const rect = parent.getBoundingClientRect();
    const cssW = Math.max(240, Math.floor(rect.width));
    const cssH = Math.max(80, Math.floor(rect.height));
    dpr = window.devicePixelRatio || 1;
    canvas.style.width = cssW + 'px';
    canvas.style.height = cssH + 'px';
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const visibleLeft = writeX - cssW;
    ecgData = ecgData.filter(p => p.x >= visibleLeft - 120);
  }

  function discreteBPM(secondsElapsed){
    const minutes = Math.floor(secondsElapsed / 60);
    return 85 + 25 * minutes;
  }

  function clearCanvas(){
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width/dpr, canvas.height/dpr);
  }

  function frame(ts){
    if (!lastFrame) lastFrame = ts;
    const dt = (ts - lastFrame) / 1000;
    lastFrame = ts;

    if (isRunning){
      const elapsedSec = (ts - ecgStartTime) / 1000;
      // si forceHR tiene valor, lo usamos; en caso contrario calculamos según patrón
      const hr = (forceHR !== null) ? forceHR : discreteBPM(elapsedSec);
      const beatInterval = 60 / hr;
      const pxPerBeat = ecgPattern.length * sampleSpacing;
      const pixelPerSecond = pxPerBeat / beatInterval;
      writeX += pixelPerSecond * dt;

      // expected beats since ECG start (use floor to avoid drift)
      const expectedBeats = Math.floor(elapsedSec / beatInterval) + 1;
      while (totalBeats < expectedBeats){
        const baseX = writeX;
        const centerY = (canvas.height / dpr) / 2;
        for (let i=0;i<ecgPattern.length;i++){
          const px = baseX + i * sampleSpacing;
          const vy = centerY + (-ecgPattern[i] * ((canvas.height/dpr) * 0.28));
          ecgData.push({x: px, y: vy});
        }
        totalBeats++;
        // play sound for this beat (if enabled)
        try { playBeep(); } catch(e){ console.warn('error playing beep', e); }
      }

      const centerY = (canvas.height / dpr) / 2;
      ecgData.push({x: writeX, y: centerY});

      const visibleLeft = writeX - (canvas.width / dpr);
      ecgData = ecgData.filter(p => p.x >= visibleLeft - 80);

      // draw grid / line
      clearCanvas();
      ctx.lineWidth = 1;
      ctx.strokeStyle = '#00ff33';
      ctx.beginPath();
      for (let i=0;i<ecgData.length;i++){
        const p = ecgData[i];
        if (i===0) ctx.moveTo(p.x - visibleLeft, p.y); else ctx.lineTo(p.x - visibleLeft, p.y);
      }
      ctx.stroke();

      // update visible rate text
      document.getElementById('ecgRate').textContent = Math.round(hr);
      document.getElementById('heartRate').textContent = Math.round(hr);
    }
    raf = requestAnimationFrame(frame);
  }

  function init(){
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    raf = requestAnimationFrame(frame);
  }

  function start(){
    if (!isRunning){
      isRunning = true;
      ecgStartTime = performance.now();
      lastFrame = performance.now();
      writeX = 0;
      ecgData = [];
      totalBeats = 0;
    }
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
  }
  function stop(){ isRunning = false; }
  function reset(){
    stop();
    lastFrame = 0;
    writeX = 0;
    ecgData = [];
    totalBeats = 0;
    clearCanvas();
    document.getElementById('ecgRate').textContent = '85';
    document.getElementById('heartRate').textContent = '85';
    document.getElementById('ecgRhythm').textContent = 'Sinusal';
  }

  // sound control UI wiring
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('soundToggle');
    const vol = document.getElementById('soundVolume');
    btn.addEventListener('click', () => {
      if (!soundEnabled){
        ensureAudio();
        setTimeout(() => {
          soundEnabled = true;
          btn.textContent = 'Sonido ON';
          btn.style.background = 'linear-gradient(135deg,#0b6623,#0f9d58)';
        }, 80);
      } else {
        soundEnabled = false;
        btn.textContent = 'Activar';
        btn.style.background = '';
      }
    });
    vol.addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      setVolume(v);
    });
  });

  // expose module
  window.ECGSim = { init, start, stop, reset };

})();
</script>

<script>
// Simulation core adapted to un caso de sarampión (sin cambiar la lógica ni el diseño operativo)
let gameTime = 300;
let elapsedTime = 0;
let gameRunning = false;
let gameTimer = null;
let analgesicAdministered = false;
let remainingHalved = false;
let simulationFailed = false;
let forceHR = null;

function addSymptom(timestamp, symptoms) {
  const container = document.getElementById('symptomsContainer');
  if (!container) return;
  const div = document.createElement('div');
  div.className = 'symptom-group new';
  const symptomsHTML = symptoms.map(s => `• ${s}`).join('<br>');
  div.innerHTML = `\n    <div class="time-stamp">${timestamp}</div>\n    <div class="symptom-list">${symptomsHTML}</div>\n  `;
  container.appendChild(div);
  setTimeout(() => { div.classList.remove('new'); }, 2000);
}

function updateVitals(hr, bp, temp, spo2) {
  document.getElementById('heartRate').textContent = hr;
  document.getElementById('bloodPressure').textContent = bp;
  document.getElementById('temperature').textContent = (typeof temp === 'number') ? temp.toFixed(1) : temp;
  document.getElementById('oxygenSat').textContent = spo2;

  const hrEl = document.getElementById('hrMonitor');
  const spo2El = document.getElementById('spo2Monitor');
  if (hr >= 130) hrEl.classList.add('critical'); else hrEl.classList.remove('critical');
  if (spo2 < 92) spo2El.classList.add('critical'); else spo2El.classList.remove('critical');
}

function showAlert(type, message) {
  const effectsDiv = document.getElementById('drugEffects');
  effectsDiv.style.display = 'block';
  effectsDiv.innerHTML = `<div class="pharmacology-alert alert-${type}">${message}</div>`;
}

function formatTime(seconds) {
  const mm = Math.floor(seconds / 60).toString().padStart(2, '0');
  const ss = (seconds % 60).toString().padStart(2, '0');
  return `T+${mm}:${ss}`;
}

function checkTimedEvents() {
  // Eventos temporizados adaptados a un caso de sarampión
  if (elapsedTime === 0) {
    addSymptom('T+00:00', [
      'Ingreso por fiebre alta y prodrómico de 3 días',
      'Tos seca, coriza y conjuntivitis',
      'Manchas de Koplik reportadas',
      'Signos vitales inicialmente estables'
    ]);
    updateVitals(100, '110/70', 39.2, 98);
    document.getElementById('patientStatus').textContent = 'Evaluación inicial - sospecha de sarampión';
  } else if (elapsedTime === 60) {
    // T+01:00: aparición del exantema en cara y cuello
    addSymptom('T+01:00', [
      'Exantema maculopapular iniciando en cara y cuello',
      'Aumento de tos y malestar general',
      'Posible disminución de apetito y deshidratación leve'
    ]);
    updateVitals(110, '105/70', 39.0, 98);
  } else if (elapsedTime === 120) {
    // T+02:00: rash se extiende; riesgo de complicaciones respiratorias
    addSymptom('T+02:00', [
      'Exantema se extiende a tronco y extremidades',
      'Tos persistente y dificultad respiratoria ligera',
      'Signos de deshidratación leve en mucosas'
    ]);
    updateVitals(120, '100/65', 38.5, 96);
    document.getElementById('patientStatus').textContent = 'Rash progresivo - evaluar complicaciones (neumonía)';
  } else if (elapsedTime === 240) {
    // T+04:00: complicación respiratoria grave (neumonía) -> hipoxemia
    addSymptom('T+04:00', [
      'Empeoramiento respiratorio: Taquipnea, sibilancias y crepitantes',
      'Descenso de SpO₂ y riesgo de insuficiencia respiratoria',
      'Posible necesidad de hospitalización y soporte ventilatorio'
    ]);
    updateVitals(140, '95/60', 38.0, 88);
    document.getElementById('patientStatus').textContent = 'Complicación: neumonía - manejo urgente';
    simulationFailed = true;
    forceHR = 140;
    document.getElementById('ecgRate').textContent = 140;
    document.getElementById('heartRate').textContent = 140;
  } else if (elapsedTime === 270) {
    // Últimos 30s: empeoramiento severo
    addSymptom('T+04:30', [
      'Empeoramiento: insuficiencia respiratoria y alteración del estado de conciencia'
    ]);
    updateVitals(40, '70/40', 36.8, 80);
    document.getElementById('patientStatus').textContent = 'Estado crítico';
    simulationFailed = true;
    forceHR = 40;
    document.getElementById('ecgRate').textContent = 40;
    document.getElementById('heartRate').textContent = 40;
  }
}

function startSimulation() {
  gameRunning = true;
  gameTime = 300;
  elapsedTime = 0;
  analgesicAdministered = false;
  remainingHalved = false;
  document.getElementById('painScore').textContent = '7';
  document.getElementById('patientStatus').textContent = 'Evaluación inicial';
  const container = document.getElementById('symptomsContainer');
  container.innerHTML = `
    <div class="symptom-group active">
      <div class="time-stamp">T+00:00 - Ingreso</div>
      <div class="symptom-list">• Fiebre alta (3 días)<br>• Tos seca, coriza y conjuntivitis<br>• Manchas de Koplik</div>
    </div>
  `;

  if (gameTimer) clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    if (!gameRunning) return;
    gameTime--;
    elapsedTime = 300 - gameTime;
    updateTimerUI();
    checkTimedEvents();
    if (elapsedTime >= 60 && elapsedTime < 270) {
      const minT = 36.0, maxT = 39.6;
      const temp = Math.round((Math.random() * (maxT - minT) + minT) * 10) / 10;
      const hrEl = document.getElementById('heartRate').textContent;
      const bpEl = document.getElementById('bloodPressure').textContent;
      const spo2El = document.getElementById('oxygenSat').textContent;
      updateVitals(parseInt(hrEl) || 0, bpEl || '120/80', temp, parseInt(spo2El) || 95);
    }

    if (gameTime <= 0) {
      endSimulation('Tiempo agotado - resultado adverso');
    }
  }, 1000);

  // start ECG visual if present (original ECG module preserved)
  if (window.ECGSim && typeof window.ECGSim.start === 'function') window.ECGSim.start();
}

function stopSimulation() {
  gameRunning = false;
  if (gameTimer) { clearInterval(gameTimer); gameTimer = null; }
  if (window.ECGSim && typeof window.ECGSim.stop === 'function') window.ECGSim.stop();
}

function updateTimerUI() {
  const mm = Math.floor(gameTime / 60).toString().padStart(2, '0');
  const ss = (gameTime % 60).toString().padStart(2, '0');
  document.getElementById('mainTimer').textContent = `${mm}:${ss}`;
  if (!simulationFailed && gameTime <= 30) {
    forceHR = 210;
    document.getElementById('ecgRate').textContent = 210;
    document.getElementById('heartRate').textContent = 210;
  } else if (!simulationFailed) {
    forceHR = null;
  }

  if (gameTime <= 120) document.getElementById('mainTimer').classList.add('critical'); else document.getElementById('mainTimer').classList.remove('critical');
}

// Reglas de dosis adaptadas (sin cambiar lógica de validación)
const doseRules = {
  'paracetamol': {min:10, max:15, unit:'mg/kg', note:'dosis orientativa por administración; no exceder 4 g/día en adultos'},
  'cristaloides_iv': {min:10, max:20, unit:'mL/kg', note:'bolos iniciales según estado hemodinámico'},
  'oxygen': {min:1, max:15, unit:'L/min', note:'flujos orientativos; ajustar según satO₂ y protocolo local'},
  'antibiotic_if_bacterial': {min:10, max:20, unit:'mg/kg', note:'antibiótico empírico según protocolo local (ajustar por edad/creatinina)'},
  'immunoglobulin': {min:400, max:500, unit:'mg/kg', note:'dosis orientativa IVIg en mg/kg; confirmar según guía y disponibilidad'},
  'vitaminaA': {min:100000, max:200000, unit:'UI', note:'Dosis orientativa; en pediatría seguir tablas por edad'},
  'no_aspirina': {min:0, max:0, unit:'', note:'Evitar AINES/aspirina en infecciones virales en niños'}
};

function administerDrug() {
  const drug = document.getElementById('drugSelection').value;
  const doseInput = parseFloat(document.getElementById('drugDose').value);
  if (!drug || isNaN(doseInput) || doseInput <= 0) { showAlert('warning', 'Seleccione fármaco y dosis válida.'); return; }

  const rule = doseRules[drug];
  let doseIsGood = false;
  if (rule) {
    const tol = rule.tol || 0;
    if (rule.min === rule.max) {
      doseIsGood = Math.abs(doseInput - rule.min) <= tol;
    } else {
      doseIsGood = (doseInput >= rule.min && doseInput <= rule.max);
    }
  }

  if (doseIsGood) {
    // comportamiento original: si dosis correcta, efectos esperados (aquí simplificados)
    analgesicAdministered = true;
    let message = '';
    let painReduction = 0;
    if (drug === 'paracetamol') {
      message = 'Paracetamol administrado: alivio sintomático de la fiebre y dolor.';
      painReduction = 2;
    } else if (drug === 'vitaminaA') {
      message = 'Vitamina A administrada: medida adyuvante que reduce riesgo de complicaciones en sarampión.';
      painReduction = 0;
      // efecto sistémico: estabiliza tiempo y reduce flags de fallo leves
      simulationFailed = false;
      forceHR = null;
    }
    const currentPain = parseInt(document.getElementById('painScore').textContent);
    const newPain = Math.max(0, currentPain - painReduction);
    document.getElementById('painScore').textContent = newPain;
    showAlert('success', message + ` (dosis dentro de rango ${rule.min}${rule.unit}${rule.max===rule.min?'' : ' - ' + rule.max + rule.unit})`);
    addSymptom(formatTime(elapsedTime), [`Medicamento administrado (correcto): ${drug} (${doseInput}${rule.unit})`]);
  } else {
    // penalización por dosis fuera de rango: tiempo reducido a 1 minuto (misma lógica original)
    analgesicAdministered = false;
    remainingHalved = true;
    gameTime = 60;
    updateTimerUI();
    simulationFailed = true;
    forceHR = 200;
    document.getElementById('ecgRate').textContent = 200;
    document.getElementById('heartRate').textContent = 200;
    showAlert('danger', 'Dosis fuera de rango indicada: tiempo restante reducido a 1 minuto. Frecuencia cardiaca aumentada a 200 lpm.');
    addSymptom(formatTime(elapsedTime), [`Medicamento administrado (FUERA DE RANGO): ${drug} (${doseInput}), penalización aplicada: tiempo = 1 min`]);
  }
}

function confirmTreatment() {
  const diagnosis = document.getElementById('diagnosis').value;
  const treatment = document.getElementById('definiteTreatment').value;
  const followUp = document.getElementById('followUp').value;
  if (!diagnosis || !treatment) { showAlert('warning', 'Complete diagnóstico y tratamiento definitivo.'); return; }
  const correctDiagnosis = diagnosis === 'sarampion_complicado';
  const correctTreatment = treatment === 'supportive_hospitalize';
  const correctFollowUp = followUp === 'monitor_resp';
  try {
    if (correctDiagnosis) addScoreEvent('diag_correct','Diagnóstico correcto: Sarampión con complicaciones', +30); else addScoreEvent('diag_incorrect','Diagnóstico incorrecto', -20);
    if (correctTreatment) addScoreEvent('treat_correct','Tratamiento correcto: Hospitalización y soporte (Vitamina A)', +40); else addScoreEvent('treat_incorrect','Tratamiento inapropiado', -30);
    if (correctFollowUp) addScoreEvent('follow_correct','Seguimiento correcto: Monitorización respiratoria en hospital', +20); else addScoreEvent('follow_incorrect','Seguimiento inadecuado', -10);
  } catch(e){ console.warn('Scoring failed', e); }
  stopSimulation();
  showResults(correctDiagnosis, correctTreatment, correctFollowUp, diagnosis, treatment, followUp);
}

function getDiagnosisText(diag) {
  const diagnoses = {
    'sarampion_classic': 'Sarampión clásico (no complicado)',
    'sarampion_complicado': 'Sarampión con complicaciones (neumonía/encefalitis)',
    'rubeola': 'Rubéola',
    'varicela': 'Varicela',
    'escarlatina': 'Escarlatina'
  };
  return diagnoses[diag] || 'No seleccionado';
}

function getTreatmentText(treat) {
  const treatments = {
    'supportive_hospitalize': 'Hospitalización y soporte (rehidratación + Vitamina A)',
    'outpatient_follow': 'Alta con aislamiento y seguimiento',
    'antibiotic_if_bacterial': 'Antibiótico si complicación bacteriana'
  };
  return treatments[treat] || 'No seleccionado';
}

function getFollowUpText(follow) {
  const followUps = {
    'isolate_notify': 'Aislamiento e notificación a salud pública',
    'monitor_resp': 'Monitorización respiratoria en hospital',
    'ambulatory_return': 'Control ambulatorio en 48-72 h'
  };
  return followUps[follow] || 'No seleccionado';
}

function getFailureConsequences(correctDiag, correctTreat, correctFollow) {
  const parts = [];
  if (!correctDiag) parts.push('Diagnóstico incorrecto: retraso en la identificación y en medidas de control');
  if (!correctTreat) parts.push('Tratamiento inapropiado: mayor riesgo de complicaciones (neumonía, encefalitis)');
  if (!correctFollow) parts.push('Seguimiento inadecuado: riesgo de transmisión y deterioro sin control');
  return parts.join(' ');
}

function showResults(correctDiag, correctTreat, correctFollow, selDiag, selTreat, selFollow) {
  const modal = document.getElementById('resultModal');
  const modalContent = document.getElementById('modalContent');
  const allCorrect = correctDiag && correctTreat && correctFollow;
  if (!allCorrect) {
    simulationFailed = true;
    forceHR = 200;
    document.getElementById('ecgRate').textContent = 200;
    document.getElementById('heartRate').textContent = 200;
  }

  try {
    if (correctDiag) addScoreEvent('diag_correct','Diagnóstico correcto: Sarampión con complicaciones', +30); else addScoreEvent('diag_incorrect','Diagnóstico incorrecto', -20);
    if (correctTreat) addScoreEvent('treat_correct','Tratamiento correcto: Hospitalización y soporte (Vitamina A)', +40); else addScoreEvent('treat_incorrect','Tratamiento inapropiado', -30);
    if (correctFollow) addScoreEvent('follow_correct','Seguimiento correcto: Monitorización respiratoria en hospital', +20); else addScoreEvent('follow_incorrect','Seguimiento inadecuado', -10);
  } catch(e){ console.warn('Scoring events failed', e); }

  let resultHTML = '';
  if (allCorrect) {
    resultHTML = `
      <div class="success-result">
        <div class="result-icon">✅</div>
        <h3>¡CASO EXITOSO!</h3>
        <p>Manejo clínico óptimo completado</p>
      </div>
      <div style="text-align:left;margin:20px 0">
        <h4>Evaluación:</h4>
        <p style="color:green">✓ <strong>Diagnóstico correcto:</strong> Sarampión con complicaciones</p>
        <p style="color:green">✓ <strong>Tratamiento correcto:</strong> Hospitalización y Vitamina A</p>
        <p style="color:green">✓ <strong>Seguimiento correcto:</strong> Monitorización respiratoria en hospital</p>
      </div>
      <div style="background:#e8f5e8;padding:15px;border-radius:5px;margin:20px 0">
        <strong>Resultado clínico esperado:</strong><br>
        Estabilización con manejo de soporte, tratamiento adyuvante con vitamina A y reducción del riesgo de progresión a complicaciones graves si se mantiene el manejo adecuado.
      </div>
    `;
  } else {
    resultHTML = `
      <div class="failure-result">
        <div class="result-icon">❌</div>
        <h3>CASO FALLIDO</h3>
        <p>Manejo clínico subóptimo</p>
      </div>
      <div style="text-align:left;margin:20px 0">
        <h4>Evaluación:</h4>
        <p style="color:${correctDiag ? 'green' : 'red'}">${correctDiag ? '✓' : '✗'} <strong>Diagnóstico:</strong> ${getDiagnosisText(selDiag)}</p>
        <p style="color:${correctTreat ? 'green' : 'red'}">${correctTreat ? '✓' : '✗'} <strong>Tratamiento:</strong> ${getTreatmentText(selTreat)}</p>
        <p style="color:${correctFollow ? 'green' : 'red'}">${correctFollow ? '✓' : '✗'} <strong>Seguimiento:</strong> ${getFollowUpText(selFollow)}</p>
      </div>
      <div style="background:#ffeaea;padding:15px;border-radius:5px;margin:20px 0">
        <strong>Consecuencias del manejo subóptimo:</strong><br>
        ${getFailureConsequences(correctDiag, correctTreat, correctFollow)}
      </div>
    `;
  }
  document.getElementById('modalTitle').textContent = allCorrect ? 'Éxito Clínico' : 'Fallo en Manejo';
  modalContent.innerHTML = resultHTML;
  modal.style.display = 'flex';
}

function endSimulation(reason) {
  stopSimulation();
  simulationFailed = true;
  forceHR = 200;
  document.getElementById('ecgRate').textContent = 200;
  document.getElementById('heartRate').textContent = 200;
  const modal = document.getElementById('resultModal');
  document.getElementById('modalTitle').textContent = 'Finalización de Simulación';
  document.getElementById('modalContent').innerHTML = `<div style="padding:10px;background:#fff5f5;border-radius:6px"><strong>${reason}</strong><p>Resultado adverso por manejo o tiempo.</p></div>`;
  modal.style.display = 'flex';
}

// listeners y arranque (preservando comportamiento original)
document.addEventListener('DOMContentLoaded', () => {
  if (window.ECGSim && typeof window.ECGSim.init === 'function') window.ECGSim.init();
  startSimulation();
  document.getElementById('administerDrug').addEventListener('click', administerDrug);
  document.getElementById('submitTreatment').addEventListener('click', confirmTreatment);
  document.getElementById('newSimBtn').addEventListener('click', () => { document.getElementById('resultModal').style.display = 'none'; startSimulation(); });

  const drugSel = document.getElementById('drugSelection');
  const doseUnitEl = document.getElementById('doseUnit');
  const doseInputEl = document.getElementById('drugDose');
  drugSel.addEventListener('change', () => {
    const val = drugSel.value;
    if (doseRules[val]) {
      doseUnitEl.textContent = doseRules[val].unit || 'mg';
      doseInputEl.placeholder = `Dosis en ${doseRules[val].unit}`;
      if (doseRules[val].unit === 'µg') {
        doseInputEl.step = 1;
        doseInputEl.max = 10000;
      } else {
        doseInputEl.step = 0.1;
        doseInputEl.max = 1000000;
      }
    } else {
      doseUnitEl.textContent = 'mg';
      doseInputEl.placeholder = 'Dosis';
      doseInputEl.step = 0.1;
    }
  });

  const confirmBtn = document.getElementById('confirmLabs');
  const labCheckboxes = Array.from(document.querySelectorAll('.labCheckbox'));
  const labStatus = document.getElementById('labStatus');
  const labResults = document.getElementById('labResults');
  if (confirmBtn) {
    function getSelected(){
      return labCheckboxes.filter(c => c.checked).map(c => c.value);
    }
    confirmBtn.addEventListener('click', () => {
      const sel = getSelected();
      labStatus.textContent = sel.length ? `${sel.length} estudio(s) seleccionado(s)` : 'No se seleccionó ningún estudio';
      if (sel.length === 0){ labResults.style.display = 'none'; labResults.innerHTML = ''; return; }
      const parts = [];
      sel.forEach(s => {
        if (s === 'bh') {
          parts.push('<h4>Hemograma</h4><p>Leucopenia moderada y linfocitosis relativa — hallazgo compatible con infección viral.</p>');
        } else if (s === 'ser') {
          parts.push('<h4>Serología</h4><p>IgM para sarampión positivo — confirma infección aguda. IgG puede estar ausente o en aumento.</p>');
        } else if (s === 'rx') {
          parts.push('<h4>Radiografía de tórax</h4><p>Infiltrados intersticiales/bilaterales sugerentes de neumonía viral o sobreinfección bacteriana.</p>');
        } else if (s === 'o2') {
          parts.push('<h4>Oxigenación</h4><p>SpO₂: 88% en este momento — correlaciona con compromiso respiratorio.</p>');
        }
      });
      labResults.innerHTML = parts.join('<hr>');
      labResults.style.display = 'block';
    });
  }
});

</script>

<!-- SCORE: mantener parche de puntuación original (máx 100) -->
<script>
(function(){
  if (window.__teniaStyleScoringLoaded) return; window.__teniaStyleScoringLoaded = true;
  window.simScore = window.simScore || { max: 100, percent: 0, events: {} };
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  const mapping = { 'diag_correct': 40, 'diag_incorrect': -20, 'treat_correct': 40, 'treat_incorrect': -20, 'follow_correct': 20, 'follow_incorrect': -10 };
  window.addScoreEvent = function(id, label, valuePercent){
    try {
      if (!id) return;
      window.simScore.events = window.simScore.events || {};
      if (window.simScore.events[id]) return;
      const val = (mapping.hasOwnProperty(id)) ? mapping[id] : (Number(valuePercent) || 0);
      window.simScore.events[id] = { label: label || id, value: val, time: new Date().toISOString() };
      window.simScore.percent = clamp((window.simScore.percent || 0) + val, 0, 100);
      window.simScore.score = Math.round(window.simScore.percent * (window.simScore.max || 100) / 100);
    } catch (e) { console.warn('addScoreEvent error', e); }
  };
  function safeWrap(name, fn){
    var attempts = 0; var maxAttempts = 40;
    var interval = setInterval(function(){
      attempts++;
      if (typeof window[name] === 'function'){
        var orig = window[name];
        window[name] = function(){
          var res = orig.apply(this, arguments);
          try { fn.apply(this, arguments); } catch(e) { console.warn('wrap fn error', e); }
          return res;
        };
        clearInterval(interval);
      } else if (attempts >= maxAttempts){
        window[name] = function(){ try { fn.apply(this, arguments); } catch(e){} };
        clearInterval(interval);
      }
    }, 120);
  }
  safeWrap('showResults', function(){ try { var modalContent = document.getElementById('modalContent') || document.querySelector('.modal-content'); if (modalContent) modalContent.insertAdjacentHTML('beforeend', getScoreSummaryHTML()); } catch(e){} });
  safeWrap('endSimulation', function(){ try { var modalContent = document.getElementById('modalContent') || document.querySelector('.modal-content'); if (modalContent) modalContent.insertAdjacentHTML('beforeend', getScoreSummaryHTML()); } catch(e){} });
  window.simScore.percent = window.simScore.percent || 0;
  window.simScore.score = Math.round(clamp(window.simScore.percent,0,100) * window.simScore.max / 100);
  function getScoreSummaryHTML(){
    const items = Object.keys(window.simScore.events || {}).map(k => { const e = window.simScore.events[k]; const sign = (e.value >= 0) ? '+' : ''; return `<li style="margin:6px 0">${e.label}: <strong>${sign}${e.value}%</strong></li>`; }).join('');
    const percent = clamp(window.simScore.percent || 0, 0, 100);
    const numeric = Math.round(percent * (window.simScore.max || 100) / 100);
    return `\n<div style="background:#eef5ff;padding:12px;border-radius:6px;margin-top:12px;text-align:left">\n  <h4 style=\"margin-top:0\">Puntuación</h4>\n  <p><strong>${numeric} / ${window.simScore.max}</strong> — <em>${percent}%</em></p>\n  <ul style=\"padding-left:18px;margin-top:8px\">${items || '<li>No se registraron eventos</li>'}</ul>\n</div>\n`;
  }
  console.log('Parche de puntuación estilo Tenia cargado (máx=' + window.simScore.max + ')');
})();
</script>

</body>
</html>
