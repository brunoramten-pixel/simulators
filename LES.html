<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SIMULADOR CLÍNICO AVANZADO - Lupus Eritematoso Sistémico - RESET TIEMPO</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui, "Segoe UI", Roboto, sans-serif;background:#f5f6fa;color:#2c3e50;font-size:13px}
.medical-header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:8px 0;position:fixed;top:0;left:0;right:0;z-index:100}
.header-content{max-width:1400px;margin:0 auto;padding:0 15px;display:flex;justify-content:space-between;align-items:center}
.system-title{font-size:1.2em;font-weight:700}
.timer-bar{position:fixed;top:50px;left:0;right:0;background:#fff;padding:8px 15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);z-index:99;display:flex;justify-content:space-between;align-items:center}
.main-timer{background:linear-gradient(135deg,#8e44ad,#6f42c1);color:#fff;padding:8px 15px;border-radius:4px;font-size:1.6em;font-weight:700;font-family:"Courier New",monospace;min-width:120px;text-align:center}
.main-timer.critical{animation:criticalFlash 1s infinite}
@keyframes criticalFlash{0%,50%{opacity:1}51%,100%{opacity:.6}}
.panel{background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.08);display:flex;flex-direction:column;overflow:hidden}
.panel-header{color:#fff;padding:10px 15px;font-size:1em;font-weight:600}
.patient-header{background:linear-gradient(135deg,#3498db,#2980b9)}
.treatment-header{background:linear-gradient(135deg,#27ae60,#229954)}
.panel-content{padding:12px;flex:1;overflow:auto}
.info-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px}
.info-card{background:#f8f9fa;padding:6px;border-radius:4px;text-align:center;border-left:2px solid #3498db}
.info-label{font-size:.7em;color:#666;text-transform:uppercase;letter-spacing:.3px}
.info-value{font-size:.85em;font-weight:600;color:#2c3e50;margin-top:1px}
.patient-visual-container{display:grid;grid-template-columns:140px 1fr;gap:15px;margin:10px 0;height:180px}
.patient-visual{display:flex;justify-content:center;align-items:center;background:#f8f9fa;border-radius:6px;padding:10px;position:relative}
.ecg-monitor{background:#000;border-radius:6px;padding:10px;position:relative;border:2px solid #222}
.ecg-header{color:#00ff00;font-family:"Courier New",monospace;font-size:.8em;text-align:center;margin-bottom:6px}
.ecg-layer{position:relative;height:120px}
canvas#ecgCanvas{width:100%;height:120px;background:#000;border-radius:2px;display:block}
.ecg-info{color:#00ff00;font-family:"Courier New",monospace;font-size:.7em;text-align:center;margin-top:6px}
.ecg-led{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;box-shadow:0 0 6px #00ff00;background:#00ff00}
.compact-vitals{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:10px 0}
.vital-compact{background:#000;color:#00ff00;padding:8px;border-radius:4px;font-family:"Courier New",monospace;position:relative;border:1px solid #333;text-align:center}
.vital-compact.critical{color:#ff0000;border-color:#dc3545;animation:criticalAlarm 1.5s infinite}
@keyframes criticalAlarm{0%,50%{background:#000}51%,100%{background:#220000}}
.pain-meter-compact{background:linear-gradient(135deg,#dc3545,#8b0000);color:#fff;padding:8px;border-radius:4px;text-align:center;margin:8px 0}
.pain-scale-compact{font-size:1.8em;font-weight:700}
.symptoms-timeline{background:#f8f9fa;border-radius:4px;padding:8px;margin:8px 0;border-left:3px solid #3498db}
.symptom-group{margin-bottom:6px;padding:6px;background:#fff;border-radius:3px;border-left:2px solid #dee2e6;opacity:0.95}
.symptom-group.active{border-left-color:#e74c3e;background:#fff5f5}
.form-group{margin-bottom:10px} .form-label{display:block;margin-bottom:4px;font-weight:600;color:#34495e;font-size:.85em} .form-control{width:100%;padding:6px 8px;border:1px solid #dee2e6;border-radius:3px;font-size:.8em}
.btn{background:linear-gradient(135deg,#27ae60,#229954);color:#fff;border:0;padding:8px 12px;border-radius:3px;font-size:.8em;font-weight:600;cursor:pointer}
.btn.urgent{background:linear-gradient(135deg,#dc3545,#8b0000);animation:urgentPulse 2s infinite}
@keyframes urgentPulse{0%,100%{box-shadow:0 1px 2px rgba(220,53,69,.3)}50%{box-shadow:0 2px 6px rgba(220,53,69,.6)}}
.pharmacology-alert{padding:8px;border-radius:3px;margin:6px 0;font-size:.75em;font-weight:600}
.alert-success{background:#ccf2e8;border:1px solid #99e6d1;color:#155724}
.alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
.alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(44,62,80,.95);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:6px;max-width:800px;width:90%;max-height:80vh;overflow:auto;text-align:center}
.success-result{background:linear-gradient(135deg,#27ae60,#229954);color:#fff;padding:15px;border-radius:6px;margin:10px 0}
.failure-result{background:linear-gradient(135deg,#e74c3e,#c0392b);color:#fff;padding:15px;border-radius:6px;margin:10px 0}
.result-icon{font-size:3em;margin:10px 0}
.paused-overlay{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.9);font-weight:700;font-size:1.2em;pointer-events:none}
.patient-history{background:#fff;padding:8px;border-radius:6px;border:1px solid #e6eef7;margin:10px 0}
.patient-history h4{margin-bottom:6px;font-size:.9em}
@media (max-width:900px){ .main-container{grid-template-columns:1fr} .header-content{flex-direction:column;gap:6px} }
</style>
</head>
<body>
<div class="medical-header">
  <div class="header-content">
    <div>
      <div class="system-title">SIMULADOR FARMACOLÓGICO AVANZADO</div>
      <div style="font-size:.8em;opacity:.9">Escuela de Medicina | Enfermedades Autoinmunes - Lupus</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:.8em"></div>
      <div style="font-size:.7em;opacity:.8">Protocolo: Manejo de Lupus Eritematoso Sistémico (SLE)</div>
    </div>
  </div>
</div>

<div class="timer-bar">
  <div class="main-timer" id="mainTimer">05:00</div>
  <div style="display:flex;gap:12px;align-items:center">
    <div style="color:#666;font-size:.9em">Estado: <span id="patientStatus">Evaluación inicial</span></div>
  </div>
</div>

<div class="main-container">
  <div class="panel patient-panel">
    <div class="panel-header patient-header">MONITOREO DEL PACIENTE</div>
    <div class="panel-content">
      <div class="info-grid">
        <div class="info-card"><div class="info-label">Paciente</div><div class="info-value">María López</div></div>
        <div class="info-card"><div class="info-label">Edad</div><div class="info-value">28 años</div></div>
        <div class="info-card"><div class="info-label">Peso</div><div class="info-value">62 kg</div></div>
        <div class="info-card"><div class="info-label">Talla</div><div class="info-value">1.62 m</div></div>
      </div>

      <div class="patient-visual-container">
        <div class="patient-visual" id="visualWrap">
          <div class="body-silhouette" id="patientBody">
            <div class="body-part head" id="partHead"></div>
            <div class="body-part torso" id="partTorso"></div>
            <div class="body-part arm-left" id="partArmL"></div>
            <div class="body-part arm-right" id="partArmR"></div>
            <div class="body-part leg-left" id="partLegL"></div>
            <div class="body-part leg-right" id="partLegR"></div>
          </div>
        </div>

        <div class="ecg-monitor" id="ecgMonitor">
          <div class="ecg-led" id="ecgLed"></div>
          <div class="ecg-header">ELECTROCARDIOGRAMA</div>
          <div class="ecg-layer">
            <canvas id="ecgCanvas" width="800" height="120"></canvas>
            <div class="paused-overlay" id="ecgPaused" style="display:none">PAUSADO</div>
          </div>
          <div class="ecg-info">FC: <span id="ecgRate">80</span> lpm | Ritmo: <span id="ecgRhythm">Sinusal</span></div>

          <div class="sound-controls" style="position:relative;margin-top:10px">
            <div class="sound-label">Sonido monitor:</div>
            <button id="soundToggle" class="sound-btn">Activar</button>
            <div style="display:flex;align-items:center;margin-left:8px">
              <input id="soundVolume" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px" title="Volumen"/>
            </div>
          </div>
        </div>
      </div>

      <div class="pain-meter-compact">
        <div style="font-size:.8em">ESCALA ANÁLOGA VISUAL</div>
        <div class="pain-scale-compact" id="painScore">5</div>
        <div style="font-size:.7em">Dolor articular / malestar</div>
      </div>

      <div class="compact-vitals">
        <div class="vital-compact" id="hrMonitor"><div class="vital-value-compact" id="heartRate">80</div><div class="vital-label-compact">FC (lpm)</div></div>
        <div class="vital-compact" id="bpMonitor"><div class="vital-value-compact" id="bloodPressure">130/78</div><div class="vital-label-compact">PA (mmHg)</div></div>
        <div class="vital-compact" id="tempMonitor"><div class="vital-value-compact" id="temperature">37.5</div><div class="vital-label-compact">TEMP (°C)</div></div>
        <div class="vital-compact" id="spo2Monitor"><div class="vital-value-compact" id="oxygenSat">98</div><div class="vital-label-compact">SpO₂ (%)</div></div>
      </div>

      <div class="patient-history" id="patientHistory">
        <h4>Antecedentes personales</h4>
        <ul style="margin-left:14px">
          <li>Rash malar fotosensible intermitente</li>
          <li>Artralgias migratorias y rigidez matutina</li>
          <li>Aftas orales recurrentes</li>
          <li>Fatiga crónica y pérdida de peso</li>
        </ul>
      </div>

      <div class="symptoms-timeline">
        <h4 style="margin-bottom:8px;color:#2c3e50;font-size:.9em">EVOLUCIÓN CLÍNICA</h4>
        <div id="symptomsContainer">
          <div class="symptom-group active">
            <div class="time-stamp">T+00:00 - Ingreso</div>
            <div class="symptom-list">• Fiebre de 7 días<br>• Dolor articular generalizado (EVA: 6/10)<br>• Rash malar y fotosensibilidad<br>• Orina espumosa y edema periorbitario</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel treatment-panel">
    <div class="panel-header treatment-header">PROTOCOLO FARMACOLÓGICO</div>
    <div class="panel-content">

      <div class="form-group">
        <label class="form-label">Selección farmacológica:</label>
        <select class="form-control" id="drugSelection">
          <option value="">-- Seleccionar fármaco/intervención --</option>
          <option value="prednisone">Prednisona / Prednisolona</option>
          <option value="iv_methylpred">Metilprednisolona IV (pulsos)</option>
          <option value="hydroxychloroquine">Hidroxicloroquina</option>
          <option value="azathioprine">Azatioprina</option>
          <option value="mycophenolate">Micofenolato mofetilo</option>
          <option value="cyclophosphamide">Ciclofosfamida</option>
          <option value="acei">IECA/ARA (para proteinuria/HT)</option>
          <option value="diuretics">Diuréticos (edema)</option>
        </select>
      </div>

      <div class="form-group" style="display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <label class="form-label">Dosis (número):</label>
          <input class="form-control" id="drugDose" type="number" min="0.1" max="10000" step="0.1" placeholder="Dosis" />
        </div>
        <div style="width:70px;margin-top:22px;text-align:left"><span id="doseUnit">mg</span></div>
      </div>

      <button class="btn urgent" id="administerDrug">ADMINISTRAR MEDICAMENTO</button>
      <div id="drugEffects" style="display:none;margin-top:8px"></div>

      <hr style="margin:12px 0;border:1px solid #dee2e6">

      <div class="form-group">
        <label class="form-label">Diagnóstico Diferencial:</label>
        <select class="form-control" id="diagnosis">
          <option value="">-- Seleccionar diagnóstico --</option>
          <option value="sle_active">Lupus sistémico - actividad moderada</option>
          <option value="sle_nephritis">Lupus con nefritis (clínica sugerida)</option>
          <option value="drug_overlap">Enfermedad mixta / Síndrome overlap</option>
          <option value="infectious">Infección sistémica (sepsis)</option>
          <option value="rheumatoid">Artritis reumatoide</option>
        </select>
      </div>

      <div class="form-group">
        <fieldset style="border:1px solid #e6eef7;padding:12px;border-radius:6px;background:#fbfcfe">
          <legend style="font-weight:700;padding:0 6px">Estudios de laboratorio</legend>
          <div style="display:flex;flex-direction:column;gap:8px;padding-top:6px">
            <label><input type="checkbox" name="labs" value="bh" class="labCheckbox"> <strong>Biometría hemática (Hb/Leucocitos/Plaquetas)</strong></label>
            <label><input type="checkbox" name="labs" value="urinalysis" class="labCheckbox"> <strong>Examen general de orina / Proteinuria</strong></label>
            <label><input type="checkbox" name="labs" value="ana" class="labCheckbox"> <strong>ANA / anti-dsDNA</strong></label>
            <label><input type="checkbox" name="labs" value="complements" class="labCheckbox"> <strong>Complemento (C3, C4)</strong></label>
            <label><input type="checkbox" name="labs" value="cr" class="labCheckbox"> <strong>Función renal (Cr, BUN)</strong></label>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="confirmLabs" class="btn">Confirmar estudios de laboratorio</button>
            <div id="labStatus" style="font-size:.85em;color:#666">Seleccione los estudios y presione confirmar.</div>
          </div>
          <div id="labResults" style="margin-top:10px;display:none;background:#fff;padding:10px;border-radius:6px;border:1px solid #e9f3ff"></div>
        </fieldset>
      </div>

      <div class="form-group">
        <label class="form-label">Tratamiento Definitivo:</label>
        <select class="form-control" id="definiteTreatment">
          <option value="">-- Seleccionar intervención --</option>
          <option value="steroids_oral">Corticoides sistémicos (oral)</option>
          <option value="iv_methylpred_short">Pulsos IV metilprednisolona</option>
          <option value="hydroxychloroquine_t">Hidroxicloroquina</option>
          <option value="immunosuppressant">Inmunosupresor (MMF/Azatioprina)</option>
          <option value="renal_support">Manejo nefrológico / ingreso</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Seguimiento:</label>
        <select class="form-control" id="followUp">
          <option value="">-- Seleccionar seguimiento --</option>
          <option value="nephrology_referral">Derivación a Nefrología y control estrecho</option>
          <option value="outpatient_follow">Control ambulatorio frecuente (semanal)</option>
          <option value="hospital_observation">Observación hospitalaria y monitorización renal</option>
        </select>
      </div>

      <button class="btn" id="submitTreatment">CONFIRMAR PLAN TERAPÉUTICO</button>
      <div id="treatmentResponse" style="display:none;margin-top:8px"></div>

    </div>
  </div>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <h2 id="modalTitle">Resultado</h2>
    <div id="modalContent"></div>
    <button class="btn" id="newSimBtn">Nueva Simulación</button>
  </div>
</div>

<script>
/* ECG integrado con sonido: comportamiento idéntico al original */
(function(){
  const canvas = document.getElementById('ecgCanvas');
  const ctx = canvas.getContext('2d');
  const parent = canvas.parentElement;
  let dpr = window.devicePixelRatio || 1;

  let audioCtx = null; let masterGain = null; let soundEnabled = false; const defaultVolume = 0.6;
  function ensureAudio(){ if (!audioCtx){ try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = defaultVolume; masterGain.connect(audioCtx.destination);} catch(e){console.warn('AudioContext no soportado', e);} } else if (audioCtx.state === 'suspended'){ audioCtx.resume(); } }
  function setVolume(v){ if (masterGain) masterGain.gain.value = v; }
  function playBeep(){ if (!soundEnabled) return; ensureAudio(); if (!audioCtx) return; const now = audioCtx.currentTime; const o1 = audioCtx.createOscillator(); const g1 = audioCtx.createGain(); o1.type = 'sine'; o1.frequency.value = 900; g1.gain.setValueAtTime(0, now); g1.gain.linearRampToValueAtTime(0.9, now + 0.002); g1.gain.exponentialRampToValueAtTime(0.001, now + 0.08); o1.connect(g1); g1.connect(masterGain); const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain(); o2.type = 'triangle'; o2.frequency.value = 1300; g2.gain.setValueAtTime(0, now); g2.gain.linearRampToValueAtTime(0.5, now + 0.002); g2.gain.exponentialRampToValueAtTime(0.001, now + 0.09); o2.connect(g2); g2.connect(masterGain); o1.start(now); o2.start(now); o1.stop(now + 0.1); o2.stop(now + 0.12); }

  let isRunning = false; let raf = null; let ecgStartTime = 0; let lastFrame = 0; let writeX = 0; let ecgData = []; let totalBeats = 0;
  const ecgPattern = [0,0,0,0.02,0.04,0.08,0.12,0.08,0.03,0,-0.05,-0.12,-0.06,0,0.15,0.8,1.0,0.78,0.28,-0.15,-0.45,-0.18,0.05,0.22,0.14,0.06,0.02,0,0,0,0,0,0];
  const sampleSpacing = 3;
  function resizeCanvas(){ const rect = parent.getBoundingClientRect(); const cssW = Math.max(240, Math.floor(rect.width)); const cssH = Math.max(80, Math.floor(rect.height)); dpr = window.devicePixelRatio || 1; canvas.style.width = cssW + 'px'; canvas.style.height = cssH + 'px'; canvas.width = Math.floor(cssW * dpr); canvas.height = Math.floor(cssH * dpr); ctx.setTransform(dpr,0,0,dpr,0,0); const visibleLeft = writeX - cssW; ecgData = ecgData.filter(p => p.x >= visibleLeft - 120); }
  function discreteBPM(secondsElapsed){ const minutes = Math.floor(secondsElapsed / 60); return 80 + 10 * minutes; }
  function clearCanvas(){ ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width/dpr, canvas.height/dpr); }
  function frame(ts){ if (!lastFrame) lastFrame = ts; const dt = (ts - lastFrame) / 1000; lastFrame = ts; if (isRunning){ const elapsedSec = (ts - ecgStartTime) / 1000; const hr = (forceHR !== null) ? forceHR : discreteBPM(elapsedSec); const beatInterval = 60 / hr; const pxPerBeat = ecgPattern.length * sampleSpacing; const pixelPerSecond = pxPerBeat / beatInterval; writeX += pixelPerSecond * dt; const expectedBeats = Math.floor(elapsedSec / beatInterval) + 1; while (totalBeats < expectedBeats){ const baseX = writeX; const centerY = (canvas.height / dpr) / 2; for (let i=0;i<ecgPattern.length;i++){ const px = baseX + i * sampleSpacing; const vy = centerY + (-ecgPattern[i] * ((canvas.height/dpr) * 0.28)); ecgData.push({x: px, y: vy}); } totalBeats++; try { playBeep(); } catch(e){ console.warn('error playing beep', e); } }
      const centerY = (canvas.height / dpr) / 2; ecgData.push({x: writeX, y: centerY}); const visibleLeft = writeX - (canvas.width / dpr); ecgData = ecgData.filter(p => p.x >= visibleLeft - 80); clearCanvas(); if (ecgData.length > 1){ ctx.beginPath(); const offset = writeX - (canvas.width / dpr); ctx.moveTo(ecgData[0].x - offset, ecgData[0].y); for (let i=1;i<ecgData.length;i++){ ctx.lineTo(ecgData[i].x - offset, ecgData[i].y); } ctx.strokeStyle = '#00ff66'; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.shadowColor = '#00ff66'; ctx.shadowBlur = 6; ctx.stroke(); ctx.shadowBlur = 0; }
      document.getElementById('ecgRate').textContent = Math.round(hr); document.getElementById('heartRate').textContent = Math.round(hr); if (hr > 150) document.getElementById('ecgRhythm').textContent = 'Taquicardia'; else if (hr < 60) document.getElementById('ecgRhythm').textContent = 'Bradicardia'; else document.getElementById('ecgRhythm').textContent = 'Sinusal'; }
    raf = requestAnimationFrame(frame); }
  function init(){ resizeCanvas(); window.addEventListener('resize', resizeCanvas); raf = requestAnimationFrame(frame); }
  function start(){ if (!isRunning){ isRunning = true; ecgStartTime = performance.now(); lastFrame = performance.now(); writeX = 0; ecgData = []; totalBeats = 0; } if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }
  function stop(){ isRunning = false; }
  function reset(){ stop(); lastFrame = 0; writeX = 0; ecgData = []; totalBeats = 0; clearCanvas(); document.getElementById('ecgRate').textContent = '80'; document.getElementById('heartRate').textContent = '80'; document.getElementById('ecgRhythm').textContent = 'Sinusal'; }
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('soundToggle'); const vol = document.getElementById('soundVolume'); btn.addEventListener('click', () => { if (!soundEnabled){ ensureAudio(); setTimeout(() => { soundEnabled = true; btn.textContent = 'Sonido ON'; btn.style.background = 'linear-gradient(135deg,#0b6623,#0f9d58)'; }, 80); } else { soundEnabled = false; btn.textContent = 'Activar'; btn.style.background = ''; } }); vol.addEventListener('input', (e) => { const v = parseFloat(e.target.value); setVolume(v); });
  });
  window.ECGSim = { init, start, stop, reset };
})();

let gameTime = 300; let elapsedTime = 0; let gameRunning = false; let gameTimer = null; let analgesicAdministered = false; let remainingHalved = false; let simulationFailed = false; let forceHR = null;

function addSymptom(timestamp, symptoms) { const container = document.getElementById('symptomsContainer'); if (!container) return; const div = document.createElement('div'); div.className = 'symptom-group new'; const symptomsHTML = symptoms.map(s => `• ${s}`).join('<br>'); div.innerHTML = `\n    <div class="time-stamp">${timestamp}</div>\n    <div class="symptom-list">${symptomsHTML}</div>\n  `; container.appendChild(div); setTimeout(() => { div.classList.remove('new'); }, 2000); }

function updateVitals(hr, bp, temp, spo2) { document.getElementById('heartRate').textContent = hr; document.getElementById('bloodPressure').textContent = bp; document.getElementById('temperature').textContent = (typeof temp === 'number') ? temp.toFixed(1) : temp; document.getElementById('oxygenSat').textContent = spo2; const hrEl = document.getElementById('hrMonitor'); const spo2El = document.getElementById('spo2Monitor'); if (hr >= 130) hrEl.classList.add('critical'); else hrEl.classList.remove('critical'); if (spo2 < 92) spo2El.classList.add('critical'); else spo2El.classList.remove('critical'); }

function showAlert(type, message) { const effectsDiv = document.getElementById('drugEffects'); effectsDiv.style.display = 'block'; effectsDiv.innerHTML = `<div class="pharmacology-alert alert-${type}">${message}</div>`; }

function formatTime(seconds) { const mm = Math.floor(seconds / 60).toString().padStart(2, '0'); const ss = (seconds % 60).toString().padStart(2, '0'); return `T+${mm}:${ss}`; }

function checkTimedEvents() {
  if (elapsedTime === 0) {
    addSymptom('T+00:00', [
      'Ingreso por fiebre prolongada y fatiga',
      'Artralgias generalizadas y rash malar presente',
      'Edema periorbitario y orina espumosa (sospecha de proteinuria)',
      'Signos vitales inicialmente estables'
    ]);
    updateVitals(82, '130/78', 37.8, 98);
    document.getElementById('patientStatus').textContent = 'Evaluación inicial - sospecha SLE activo';
  } else if (elapsedTime === 60) {
    addSymptom('T+01:00', [
      'Aumento del edema y proteinuria evidente',
      'Aparición de hipertensión arterial y cefalea',
      'Descenso leve de hemoglobina y plaquetas'
    ]);
    updateVitals(90, '140/90', 37.6, 98);
  } else if (elapsedTime === 120) {
    addSymptom('T+02:00', [
      'Progresión a insuficiencia renal aguda (oliguria, aumento Cr)',
      'Síntomas constitucionales intensificados',
      'Proteinuria masiva y edema generalizado'
    ]);
    updateVitals(100, '150/95', 37.4, 97);
    document.getElementById('patientStatus').textContent = 'Sospecha de nefritis lúpica - considerar pulsos y admisión';
  } else if (elapsedTime === 240) {
    addSymptom('T+04:00', [
      'Insuficiencia renal grave y desequilibrio electrolítico',
      'Compromiso respiratorio y sobrecarga de volumen',
      'Necesidad de soporte renal/UTI'
    ]);
    updateVitals(120, '160/100', 37.0, 95);
    document.getElementById('patientStatus').textContent = 'Complicación grave - manejo urgente';
    simulationFailed = true;
    forceHR = 120;
    document.getElementById('ecgRate').textContent = 120;
    document.getElementById('heartRate').textContent = 120;
  } else if (elapsedTime === 270) {
    addSymptom('T+04:30', [
      'Empeoramiento sistémico: alteración del estado de conciencia y riesgo vital'
    ]);
    updateVitals(40, '80/50', 36.8, 88);
    document.getElementById('patientStatus').textContent = 'Estado crítico - posible fallo multiorgánico';
    simulationFailed = true;
    forceHR = 40;
    document.getElementById('ecgRate').textContent = 40;
    document.getElementById('heartRate').textContent = 40;
  }
}

function startSimulation() {
  gameRunning = true; gameTime = 300; elapsedTime = 0; analgesicAdministered = false; remainingHalved = false; document.getElementById('painScore').textContent = '5'; document.getElementById('patientStatus').textContent = 'Evaluación inicial';
  const container = document.getElementById('symptomsContainer'); container.innerHTML = `
    <div class="symptom-group active">
      <div class="time-stamp">T+00:00 - Ingreso</div>
      <div class="symptom-list">• Fiebre prolongada y fatiga<br>• Artralgias y rash malar<br>• Proteinuria sospechada (orina espumosa)<br>• Edema periférico</div>
    </div>
  `;

  if (gameTimer) clearInterval(gameTimer);
  gameTimer = setInterval(() => {
    if (!gameRunning) return;
    gameTime--; elapsedTime = 300 - gameTime; updateTimerUI(); checkTimedEvents(); if (elapsedTime >= 60 && elapsedTime < 270) {
      const minT = 36.4, maxT = 38.6; const temp = Math.round((Math.random() * (maxT - minT) + minT) * 10) / 10; const hrEl = document.getElementById('heartRate').textContent; const bpEl = document.getElementById('bloodPressure').textContent; const spo2El = document.getElementById('oxygenSat').textContent; updateVitals(parseInt(hrEl) || 0, bpEl || '130/80', temp, parseInt(spo2El) || 95);
    }
    if (gameTime <= 0) { endSimulation('Tiempo agotado - resultado adverso'); }
  }, 1000);

  if (window.ECGSim && typeof window.ECGSim.start === 'function') window.ECGSim.start();
}

function stopSimulation() { gameRunning = false; if (gameTimer) { clearInterval(gameTimer); gameTimer = null; } if (window.ECGSim && typeof window.ECGSim.stop === 'function') window.ECGSim.stop(); }

function updateTimerUI() { const mm = Math.floor(gameTime / 60).toString().padStart(2, '0'); const ss = (gameTime % 60).toString().padStart(2, '0'); document.getElementById('mainTimer').textContent = `${mm}:${ss}`; if (!simulationFailed && gameTime <= 30) { forceHR = 140; document.getElementById('ecgRate').textContent = 140; document.getElementById('heartRate').textContent = 140; } else if (!simulationFailed) { forceHR = null; } if (gameTime <= 120) document.getElementById('mainTimer').classList.add('critical'); else document.getElementById('mainTimer').classList.remove('critical'); }

const doseRules = {
  'prednisone': {min:0.5, max:1.0, unit:'mg/kg', note:'Dosis oral diaria según actividad'},
  'iv_methylpred': {min:500, max:1000, unit:'mg', note:'Pulsos IV en crisis grave'},
  'hydroxychloroquine': {min:200, max:400, unit:'mg', note:'Diaria; ajustar por peso'},
  'azathioprine': {min:1.5, max:2.5, unit:'mg/kg', note:'dosis mantenim.'},
  'mycophenolate': {min:1000, max:2000, unit:'mg', note:'dosis total diaria'},
  'cyclophosphamide': {min:500, max:1000, unit:'mg', note:'según protocolo'},
  'acei': {min:5, max:20, unit:'mg', note:'IECA/ARA para proteinuria/HT'},
  'diuretics': {min:20, max:80, unit:'mg', note:'según diurético seleccionado'}
};

function administerDrug() {
  const drug = document.getElementById('drugSelection').value; const doseInput = parseFloat(document.getElementById('drugDose').value);
  if (!drug || isNaN(doseInput) || doseInput <= 0) { showAlert('warning', 'Seleccione fármaco y dosis válida.'); return; }
  const rule = doseRules[drug]; let doseIsGood = false; if (rule) { if (rule.min === rule.max) doseIsGood = Math.abs(doseInput - rule.min) <= (rule.tol||0); else doseIsGood = (doseInput >= rule.min && doseInput <= rule.max); }
  if (doseIsGood) {
    // efectos según fármaco
    let message = '';
    if (drug === 'iv_methylpred') {
      message = 'Pulsos de metilprednisolona administrados: respuesta rápida esperada en actividad severa.';
      addSymptom(formatTime(elapsedTime), ['Pulsos IV administrados — respuesta inmunomoduladora potencialmente rápida']);
      // mejorar signos y estabilizar tiempo
      simulationFailed = false; forceHR = null; gameTime = Math.max(180, gameTime); updateTimerUI();
    } else if (drug === 'prednisone' || drug === 'hydroxychloroquine') {
      message = 'Corticoide/hidroxicloroquina administrado: control de la inflamación sistémica (efecto no inmediato en proteinuria).';
      addSymptom(formatTime(elapsedTime), [`${drug} administrado (${doseInput}${rule.unit}) — efecto antiinflamatorio`]);
    } else {
      message = 'Medicamento administrado según protocolo.';
    }
    showAlert('success', message + ` (dosis dentro de rango)`);
  } else {
    // dosis fuera de rango -> penalización temporal
    gameTime = Math.min(60, gameTime); updateTimerUI(); simulationFailed = true; forceHR = 150; document.getElementById('ecgRate').textContent = 150; document.getElementById('heartRate').textContent = 150; showAlert('danger', 'Dosis fuera de rango indicada: consecuencia inmediata en tiempo y estado hemodinámico.'); addSymptom(formatTime(elapsedTime), [`Medicamento administrado (FUERA DE RANGO): ${drug} (${doseInput})`]);
  }
}

function confirmTreatment() {
  const diagnosis = document.getElementById('diagnosis').value; const treatment = document.getElementById('definiteTreatment').value; const followUp = document.getElementById('followUp').value; if (!diagnosis || !treatment) { showAlert('warning', 'Complete diagnóstico y tratamiento definitivo.'); return; }
  const correctDiagnosis = diagnosis === 'sle_nephritis';
  const correctTreatment = (treatment === 'iv_methylpred_short' || treatment === 'renal_support');
  const correctFollowUp = followUp === 'nephrology_referral';
  try { if (correctDiagnosis) addScoreEvent('diag_correct','Diagnóstico correcto: Nefritis lúpica', +30); else addScoreEvent('diag_incorrect','Diagnóstico incorrecto', -20); if (correctTreatment) addScoreEvent('treat_correct','Tratamiento correcto: Pulsos IV / manejo nefrológico', +40); else addScoreEvent('treat_incorrect','Tratamiento inapropiado', -30); if (correctFollowUp) addScoreEvent('follow_correct','Seguimiento correcto: Nefrología', +30); else addScoreEvent('follow_incorrect','Seguimiento inadecuado', -10);} catch(e){console.warn('Scoring failed', e);} stopSimulation(); showResults(correctDiagnosis, correctTreatment, correctFollowUp, diagnosis, treatment, followUp);
}

function getDiagnosisText(diag) { const diagnoses = { 'sle_active':'Lupus sistémico - actividad moderada', 'sle_nephritis':'Lupus con nefritis lúpica', 'drug_overlap':'Enfermedad mixta / overlap', 'infectious':'Infección sistémica', 'rheumatoid':'Artritis reumatoide' }; return diagnoses[diag] || 'No seleccionado'; }
function getTreatmentText(treat) { const treatments = { 'steroids_oral':'Corticoides sistémicos (oral)', 'iv_methylpred_short':'Pulsos IV de metilprednisolona', 'hydroxychloroquine_t':'Hidroxicloroquina', 'immunosuppressant':'Inmunosupresor (MMF/Azatioprina)', 'renal_support':'Manejo nefrológico / ingreso' }; return treatments[treat] || 'No seleccionado'; }
function getFollowUpText(follow) { const followUps = { 'nephrology_referral':'Derivación a Nefrología', 'outpatient_follow':'Control ambulatorio frecuente', 'hospital_observation':'Observación hospitalaria y monitorización renal' }; return followUps[follow] || 'No seleccionado'; }
function getFailureConsequences(correctDiag, correctTreat, correctFollow) { const parts = []; if (!correctDiag) parts.push('Diagnóstico incorrecto: retraso en tratamiento específico.'); if (!correctTreat) parts.push('Tratamiento inapropiado: progresión a daño orgánico irreversible.'); if (!correctFollow) parts.push('Seguimiento inadecuado: riesgo de recaída o daño renal crónico.'); return parts.join(' '); }

function showResults(correctDiag, correctTreat, correctFollow, selDiag, selTreat, selFollow) {
  const modal = document.getElementById('resultModal'); const modalContent = document.getElementById('modalContent'); const allCorrect = correctDiag && correctTreat && correctFollow; if (!allCorrect) { simulationFailed = true; forceHR = 150; document.getElementById('ecgRate').textContent = 150; document.getElementById('heartRate').textContent = 150; }
  try { if (correctDiag) addScoreEvent('diag_correct','Diagnóstico correcto: Nefritis lúpica', +30); else addScoreEvent('diag_incorrect','Diagnóstico incorrecto', -20); if (correctTreat) addScoreEvent('treat_correct','Tratamiento correcto: Pulsos IV / manejo nefrológico', +40); else addScoreEvent('treat_incorrect','Tratamiento inapropiado', -30); if (correctFollow) addScoreEvent('follow_correct','Seguimiento correcto: Nefrología', +30); else addScoreEvent('follow_incorrect','Seguimiento inadecuado', -10);} catch(e){console.warn('Scoring events failed', e); }
  let resultHTML = '';
  if (allCorrect) {
    resultHTML = `
      <div class="success-result">
        <div class="result-icon">✅</div>
        <h3>¡CASO EXITOSO!</h3>
        <p>Manejo clínico óptimo completado</p>
      </div>
      <div style="text-align:left;margin:20px 0">
        <h4>Evaluación:</h4>
        <p style="color:green">✓ <strong>Diagnóstico correcto:</strong> Nefritis lúpica</p>
        <p style="color:green">✓ <strong>Tratamiento correcto:</strong> Pulsos IV / Manejo nefrológico</p>
        <p style="color:green">✓ <strong>Seguimiento correcto:</strong> Derivación a Nefrología</p>
      </div>
      <div style="background:#e8f5e8;padding:15px;border-radius:5px;margin:20px 0">
        <strong>Resultado clínico esperado:</strong><br>
        Mejoría hemodinámica y control de la actividad inmunológica con reducción del riesgo de daño renal si se mantiene el manejo adecuado.
      </div>
    `;
  } else {
    resultHTML = `
      <div class="failure-result">
        <div class="result-icon">❌</div>
        <h3>CASO FALLIDO</h3>
        <p>Manejo clínico subóptimo</p>
      </div>
      <div style="text-align:left;margin:20px 0">
        <h4>Evaluación:</h4>
        <p style="color:${correctDiag ? 'green' : 'red'}">${correctDiag ? '✓' : '✗'} <strong>Diagnóstico:</strong> ${getDiagnosisText(selDiag)}</p>
        <p style="color:${correctTreat ? 'green' : 'red'}">${correctTreat ? '✓' : '✗'} <strong>Tratamiento:</strong> ${getTreatmentText(selTreat)}</p>
        <p style="color:${correctFollow ? 'green' : 'red'}">${correctFollow ? '✓' : '✗'} <strong>Seguimiento:</strong> ${getFollowUpText(selFollow)}</p>
      </div>
      <div style="background:#ffeaea;padding:15px;border-radius:5px;margin:20px 0">
        <strong>Consecuencias del manejo subóptimo:</strong><br>
        ${getFailureConsequences(correctDiag, correctTreat, correctFollow)}
      </div>
    `;
  }
  document.getElementById('modalTitle').textContent = allCorrect ? 'Éxito Clínico' : 'Fallo en Manejo'; modalContent.innerHTML = resultHTML; modal.style.display = 'flex';
}

function endSimulation(reason) { stopSimulation(); simulationFailed = true; forceHR = 150; document.getElementById('ecgRate').textContent = 150; document.getElementById('heartRate').textContent = 150; const modal = document.getElementById('resultModal'); document.getElementById('modalTitle').textContent = 'Finalización de Simulación'; document.getElementById('modalContent').innerHTML = `<div style="padding:10px;background:#fff5f5;border-radius:6px"><strong>${reason}</strong><p>Resultado adverso por manejo o tiempo.</p></div>`; modal.style.display = 'flex'; }

// listeners y arranque
document.addEventListener('DOMContentLoaded', () => {
  if (window.ECGSim && typeof window.ECGSim.init === 'function') window.ECGSim.init(); startSimulation(); document.getElementById('administerDrug').addEventListener('click', administerDrug); document.getElementById('submitTreatment').addEventListener('click', confirmTreatment); document.getElementById('newSimBtn').addEventListener('click', () => { document.getElementById('resultModal').style.display = 'none'; startSimulation(); });
  const ecgCanvas = document.getElementById('ecgCanvas'); ecgCanvas.addEventListener('click', () => { const paused = document.getElementById('ecgPaused'); if (gameRunning) { stopSimulation(); paused.style.display = 'flex'; } else { startSimulation(); paused.style.display = 'none'; } });
  const drugSel = document.getElementById('drugSelection'); const doseUnitEl = document.getElementById('doseUnit'); const doseInputEl = document.getElementById('drugDose'); drugSel.addEventListener('change', () => { const val = drugSel.value; if (doseRules[val]) { doseUnitEl.textContent = doseRules[val].unit || 'mg'; doseInputEl.placeholder = `Dosis en ${doseRules[val].unit}`; if (doseRules[val].unit === 'µg') { doseInputEl.step = 1; doseInputEl.max = 10000; } else { doseInputEl.step = 0.1; doseInputEl.max = 1000; } } else { doseUnitEl.textContent = 'mg'; doseInputEl.placeholder = 'Dosis'; doseInputEl.step = 0.1; } });
});

// lab results handler
document.addEventListener('DOMContentLoaded', () => {
  const confirmBtn = document.getElementById('confirmLabs'); const labCheckboxes = Array.from(document.querySelectorAll('.labCheckbox')); const labStatus = document.getElementById('labStatus'); const labResults = document.getElementById('labResults'); if (!confirmBtn) return; function getSelected(){ return labCheckboxes.filter(c => c.checked).map(c => c.value); }
  confirmBtn.addEventListener('click', () => {
    const sel = getSelected(); labStatus.textContent = sel.length ? `${sel.length} estudio(s) seleccionado(s)` : 'No se seleccionó ningún estudio'; if (sel.length === 0){ labResults.style.display = 'none'; labResults.innerHTML = ''; return; }
    const parts = [];
    sel.forEach(s => {
      if (s === 'bh') { parts.push('<h4>Biometría hemática</h4><p>Hb: 10.2 g/dL (anemia de enfermedad crónica / hemolítica leve)<br>Leucopenia: 3.2 x10^3/µL<br>Plaquetas: 120 x10^3/µL</p>'); }
      else if (s === 'urinalysis') { parts.push('<h4>Examen de orina</h4><p>Proteinuria ++, hematuria microscópica, sedimento activo — sugiere compromiso renal (nefritis lúpica)</p>'); }
      else if (s === 'ana') { parts.push('<h4>Serología</h4><p>ANA: positivo en patrón moteado intenso<br>Anti-dsDNA: elevado — correlaciona con actividad renal</p>'); }
      else if (s === 'complements') { parts.push('<h4>Complemento</h4><p>C3: disminuido, C4: disminuido — indicador de actividad inmunológica</p>'); }
      else if (s === 'cr') { parts.push('<h4>Función renal</h4><p>Creatinina: 2.1 mg/dL — elevación respecto a la normalidad; BUN elevado</p>'); }
    }); labResults.innerHTML = parts.join('<hr>'); labResults.style.display = 'block';
  });
});

// simple scoring wrapper
(function(){ if (window.__teniaStyleScoringLoaded) return; window.__teniaStyleScoringLoaded = true; window.simScore = window.simScore || { max: 100, percent: 0, events: {} }; function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  const mapping = { 'diag_correct':40,'diag_incorrect':-20,'treat_correct':40,'treat_incorrect':-20,'follow_correct':30,'follow_incorrect':-10 };
  window.addScoreEvent = function(id, label, valuePercent){ try { if (!id) return; window.simScore.events = window.simScore.events || {}; if (window.simScore.events[id]) return; const val = (mapping.hasOwnProperty(id)) ? mapping[id] : (Number(valuePercent) || 0); window.simScore.events[id] = { label: label || id, value: val, time: new Date().toISOString() }; window.simScore.percent = clamp((window.simScore.percent || 0) + val, 0, 100); window.simScore.score = Math.round(window.simScore.percent * (window.simScore.max || 100) / 100); } catch (e) { console.warn('addScoreEvent error', e); } };
  function safeWrap(name, fn){ var attempts = 0; var maxAttempts = 40; var interval = setInterval(function(){ attempts++; if (typeof window[name] === 'function'){ var orig = window[name]; window[name] = function(){ var res = orig.apply(this, arguments); try { fn.apply(this, arguments); } catch(e) { console.warn('wrap fn error', e); } return res; }; clearInterval(interval); } else if (attempts >= maxAttempts){ window[name] = function(){ try { fn.apply(this, arguments); } catch(e){} }; clearInterval(interval); } }, 120); }
  safeWrap('showResults', function(){ try { var modalContent = document.getElementById('modalContent') || document.querySelector('.modal-content'); if (modalContent) { var scoreHTML = `<div style="background:#eef5ff;padding:12px;border-radius:6px;margin-top:12px;text-align:left"><h4 style=\"margin-top:0\">Puntuación</h4><p><strong>${Math.round(window.simScore.score||0)} / ${window.simScore.max}</strong></p><ul style=\"padding-left:18px;margin-top:8px\">${Object.keys(window.simScore.events||{}).map(k=>`<li style=\"margin:6px 0\">${window.simScore.events[k].label}: <strong>${window.simScore.events[k].value>0?'+':''}${window.simScore.events[k].value}%</strong></li>`).join('')||'<li>No se registraron eventos</li>'}</ul></div>`; modalContent.innerHTML += scoreHTML; } } catch(e){} });
})();

</script>
</body>
</html>
